<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>XAUUSD Trading Dashboard</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <link rel="stylesheet" href="/static/style.css?v=4">
    <style>
        .debug-console {
            background: #0a0e27;
            color: #00ff00;
            padding: 10px;
            font-family: monospace;
            font-size: 10px;
            max-height: 120px;
            overflow-y: auto;
            border: 1px solid #333;
            margin: 10px;
            display: none;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .debug-console.active {
            display: block;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.3s;
        }
        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .loading-text {
            color: #ffd700;
            font-size: 18px;
            text-align: center;
        }
        .loading-spinner-large {
            width: 50px;
            height: 50px;
            border: 4px solid #2a2a4e;
            border-top-color: #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">
        <div>
            <div class="loading-spinner-large"></div>
            <div class="loading-text">Memuat Dashboard...</div>
        </div>
    </div>

    <div id="debug-console" class="debug-console"></div>
    
    <div class="container">
        <div class="header">
            <h1>XAUUSD</h1>
            <div class="subtitle">Xauusd Dzeck Trader</div>
            <div id="user-greeting" class="user-greeting guest">üëÅÔ∏è Mode Tamu</div>
            <div class="status-indicator">
                <span class="status-dot connecting"></span>
                <span class="status-text connecting">MENYAMBUNG...</span>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <span class="card-title">üí∞ Harga Real-Time</span>
                <span class="card-badge live-badge">LIVE</span>
            </div>
            <div class="price-display">
                <div class="price-main" id="price-main">Memuat...</div>
                <div class="price-change positive" id="price-change">--</div>
                <div class="price-details">
                    <div class="price-detail">
                        <div class="price-detail-label">Bid</div>
                        <div class="price-detail-value" id="price-bid">--</div>
                    </div>
                    <div class="price-detail">
                        <div class="price-detail-label">Ask</div>
                        <div class="price-detail-value" id="price-ask">--</div>
                    </div>
                    <div class="price-detail">
                        <div class="price-detail-label">Spread</div>
                        <div class="price-detail-value" id="price-spread">--</div>
                    </div>
                    <div class="price-detail">
                        <div class="price-detail-label">24j Range</div>
                        <div class="price-detail-value" id="price-range">--</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <span class="card-title">üì° Sinyal Terakhir</span>
                <span class="card-icon">üîî</span>
            </div>
            <div class="signal-display">
                <div class="signal-badge neutral" id="signal-badge">
                    ‚è≥ Menunggu Sinyal
                </div>
                <div class="signal-info">
                    <div class="signal-info-item">
                        <div class="signal-info-label">Entry</div>
                        <div class="signal-info-value" id="signal-entry">--</div>
                    </div>
                    <div class="signal-info-item">
                        <div class="signal-info-label">SL</div>
                        <div class="signal-info-value" id="signal-sl">--</div>
                    </div>
                    <div class="signal-info-item">
                        <div class="signal-info-label">TP</div>
                        <div class="signal-info-value" id="signal-tp">--</div>
                    </div>
                </div>
                <div class="signal-info" style="margin-top: 8px;">
                    <div class="signal-info-item" style="grid-column: span 3;">
                        <div class="signal-info-label">Waktu Sinyal</div>
                        <div class="signal-info-value" id="signal-time">--</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card position-card">
            <div class="card-header">
                <span class="card-title">üìä Posisi Aktif</span>
                <span class="card-badge realtime-badge">REALTIME</span>
            </div>
            <div id="position-container">
                <div class="no-position">
                    <p>Tidak ada posisi aktif</p>
                </div>
            </div>
        </div>
        
        <div class="card chart-card">
            <div class="card-header">
                <span class="card-title">üìà Chart XAUUSD M1</span>
                <span class="card-badge">AUTO UPDATE</span>
            </div>
            <div id="chart-container"></div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <span class="card-title">üéØ Market Regime</span>
                <span class="card-badge">30 DETIK</span>
            </div>
            <div class="regime-display" id="regime-tags">
                <span class="regime-tag loading">‚è≥ Menganalisis...</span>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <span class="card-title">üìâ Statistik</span>
                <span class="card-icon">üìä</span>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">Win Rate</div>
                    <div class="stat-value" id="stat-winrate">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Total P/L</div>
                    <div class="stat-value" id="stat-pnl">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Sinyal Hari Ini</div>
                    <div class="stat-value" id="stat-signals">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Total Trade</div>
                    <div class="stat-value" id="stat-trades">--</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <span class="card-title">üìú Riwayat Trading</span>
                <span class="card-badge">10 DETIK</span>
            </div>
            <div id="trade-history-container" class="trade-history">
                <div class="loading-text">Memuat riwayat...</div>
            </div>
        </div>
        
        <button class="refresh-btn" id="refresh-btn">
            üîÑ Refresh Manual
        </button>
        
        <div class="update-time" id="update-time">
            Update terakhir: --
        </div>
        
        <div class="footer-info">
            <p>Dashboard auto-update setiap 2 detik</p>
            <p>Sinyal trading unlimited 24/7</p>
        </div>
    </div>
    
    <script>
        var DEBUG = (function() {
            try {
                var urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('debug') === 'true') return true;
                if (urlParams.get('debug') === 'false') return false;
            } catch (e) {}
            return false;
        })();
        
        let loadingHidden = false;
        
        function debugLog(msg) {
            const timestamp = new Date().toLocaleTimeString('id-ID', { hour12: false });
            const fullMsg = `[${timestamp}] ${msg}`;
            if (DEBUG) {
                console.log('[DASHBOARD] ' + fullMsg);
                const debugEl = document.getElementById('debug-console');
                if (debugEl) {
                    debugEl.classList.add('active');
                    debugEl.innerHTML += fullMsg + '\n';
                    if (debugEl.innerHTML.length > 5000) {
                        debugEl.innerHTML = debugEl.innerHTML.substring(debugEl.innerHTML.length - 3000);
                    }
                    debugEl.scrollTop = debugEl.scrollHeight;
                }
            }
        }
        
        function hideLoading() {
            if (!loadingHidden) {
                const overlay = document.getElementById('loading-overlay');
                if (overlay) {
                    overlay.classList.add('hidden');
                    setTimeout(() => {
                        overlay.style.display = 'none';
                    }, 300);
                }
                loadingHidden = true;
                debugLog('Loading overlay hidden');
            }
        }
        
        debugLog('Dashboard HTML loaded - v4.0 (Real-Time)');
        debugLog('User Agent: ' + navigator.userAgent.substring(0, 50));
        debugLog('LightweightCharts available: ' + (typeof LightweightCharts !== 'undefined'));
        debugLog('Telegram WebApp available: ' + (typeof window.Telegram !== 'undefined'));
        
        window.addEventListener('load', function() {
            debugLog('Window load event fired');
            setTimeout(hideLoading, 1000);
        });
        
        setTimeout(function() {
            if (!loadingHidden) {
                debugLog('Force hiding loading overlay after timeout');
                hideLoading();
            }
        }, 5000);
    </script>
    
    <script>
        debugLog('Before loading app.js');
    </script>
    <script src="/static/app.js?v=20251201v4"></script>
    <script>
        debugLog('After loading app.js - checking if loaded');
        if (typeof refreshData === 'function') {
            debugLog('refreshData function is available');
        } else {
            debugLog('ERROR: refreshData function NOT found');
        }
    </script>
</body>
</html>
